# 通用 Agent 工作台 PRD（终稿）

> 版本：1.0 | 更新日期：2025-01

------

## 1. 产品概述

### 1.1 产品定位

**通用 Agent 工作台**是一个基于 LangGraph 的智能任务编排平台，面向需要对接复杂业务系统的企业用户。平台通过自然语言交互，将用户意图转化为可执行的多步骤任务，并提供完整的任务可视化与状态追踪能力。

### 1.2 核心价值

| 维度             | 价值                                                    |
| ---------------- | ------------------------------------------------------- |
| **降低使用门槛** | 用户无需了解底层 API 细节，通过自然语言即可完成复杂操作 |
| **提升执行效率** | Agent 自动编排任务依赖，减少人工协调成本                |
| **增强可控性**   | 全流程状态可视化，失败原因清晰可追溯                    |
| **快速扩展**     | 标准化 Tool 接入规范，支持快速对接新业务系统            |

------

## 2. 目标用户

### 2.1 主要用户

- **业务操作人员**：需要通过系统完成日常业务操作，但不熟悉底层 API
- **系统集成方**：需要将自有系统能力接入平台的开发者

### 2.2 非目标用户

- 纯技术运维人员（直接使用 API）
- 无明确业务场景的探索性用户

------

## 3. 功能需求

### 3.1 核心功能模块

#### 3.1.1 对话交互模块

| 功能         | 描述                             | 优先级 |
| ------------ | -------------------------------- | ------ |
| 自然语言输入 | 支持用户通过自然语言描述任务意图 | P0     |
| 多轮对话     | 支持上下文连续的多轮交互         | P0     |
| 对话历史     | 永久保存，支持查看历史对话       | P0     |
| 多任务创建   | 单次对话可创建多个独立任务       | P1     |

#### 3.1.2 任务规划模块（Planner Agent）

| 功能     | 描述                             | 优先级 |
| -------- | -------------------------------- | ------ |
| 意图识别 | 解析用户自然语言，提取结构化目标 | P0     |
| 任务拆解 | 将复杂目标拆解为 TODO 步骤列表   | P0     |
| 依赖推断 | 自动识别步骤间的执行依赖关系     | P0     |
| 动态调整 | 根据执行结果动态调整后续计划     | P1     |

#### 3.1.3 任务执行模块（Executor Agent）

| 功能      | 描述                                   | 优先级 |
| --------- | -------------------------------------- | ------ |
| Tool 选择 | 根据任务需求选择合适的 Tool            | P0     |
| 参数填充  | 结合知识库与上下文，自动填充 Tool 参数 | P0     |
| 执行调度  | 按依赖顺序执行 Tool 调用               | P0     |
| 重试机制  | 失败后自动重试（最多 3 次）            | P0     |

#### 3.1.4 结果校验模块（Validator Agent）

| 功能     | 描述                         | 优先级 |
| -------- | ---------------------------- | ------ |
| 结果判定 | 判定任务执行结果：成功/失败  | P0     |
| 错误归因 | 识别失败原因并定位到具体步骤 | P0     |
| 状态说明 | 使用业务语言描述执行状态     | P0     |

#### 3.1.5 可视化模块

| 功能      | 描述                                        | 优先级 |
| --------- | ------------------------------------------- | ------ |
| TODO 列表 | 垂直步骤列表展示任务计划                    | P0     |
| 状态标识  | 显示每个步骤状态：待执行/执行中/已完成/失败 | P0     |
| 进度展示  | 显示"当前步骤/总步骤"（如 3/8）             | P0     |
| 折叠/展开 | 支持折叠已完成步骤，聚焦当前                | P1     |
| 错误详情  | 失败时显示具体步骤 + 错误原因               | P0     |

#### 3.1.6 配置交互模块

| 功能       | 描述                                     | 优先级 |
| ---------- | ---------------------------------------- | ------ |
| 动态表单   | 根据 Tool Schema 自动生成配置界面        | P0     |
| 多种控件   | 支持输入框、下拉框、多选等交互形式       | P0     |
| 嵌入式弹窗 | 配置界面以嵌入式弹窗形式呈现             | P0     |
| 临时授权   | 用户对当次操作进行授权，无需持久存储凭证 | P0     |

### 3.2 平台管理功能

| 功能          | 描述                           | 优先级 |
| ------------- | ------------------------------ | ------ |
| Tool 注册接口 | 提供标准化 Tool 注册规范与接口 | P0     |
| 知识库管理    | 上传/管理领域知识文档          | P0     |
| 对话历史查看  | 查看所有历史对话记录           | P0     |
| 任务列表      | 查看当前用户的所有任务及状态   | P0     |

------

## 4. 技术架构

### 4.1 技术栈

| 层级           | 技术选型                    |
| -------------- | --------------------------- |
| **前端**       | React                       |
| **Agent 框架** | LangGraph（基于 LangChain） |
| **LLM**        | Qwen 系列（已部署）         |
| **向量数据库** | Chroma                      |
| **缓存**       | Redis                       |
| **持久化**     | PostgreSQL / MySQL          |
| **部署**       | 私有化部署                  |

### 4.2 Agent 架构

```
┌─────────────────────────────────────────────────────────┐
│                    Supervisor Agent                      │
│              (协调 Planner/Executor/Validator)           │
└─────────────────────────────────────────────────────────┘
        │                    │                    │
        ▼                    ▼                    ▼
┌───────────────┐   ┌───────────────┐   ┌───────────────┐
│ Planner Agent │   │Executor Agent │   │Validator Agent│
│   意图理解     │   │   任务执行     │   │   结果校验    │
│   任务拆解     │   │   Tool 调用   │   │   状态判定    │
└───────────────┘   └───────────────┘   └───────────────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             ▼
                    ┌───────────────┐
                    │  Shared State │
                    │   (LangGraph) │
                    └───────────────┘
```

### 4.3 支持的 Agent 模式

| 模式                 | 适用场景                         |
| -------------------- | -------------------------------- |
| **ReAct**            | 简单任务，需要工具调用与推理交替 |
| **Plan-and-Execute** | 复杂任务，需要先规划后执行       |
| **Multi-Agent**      | 需要多个专业 Agent 协作的场景    |

------

## 5. 数据流设计

### 5.1 核心数据流

```
用户输入 → 意图解析 → 任务规划 → 步骤执行 → 结果校验 → 状态反馈
    │           │           │           │           │
    └───────────┴───────────┴───────────┴───────────┘
                    State 持续更新
```

### 5.2 状态传递内容

| 字段            | 说明                     |
| --------------- | ------------------------ |
| `user_input`    | 用户原始输入             |
| `parsed_intent` | 解析后的结构化意图       |
| `todo_list`     | 任务步骤列表             |
| `current_step`  | 当前执行步骤索引         |
| `step_results`  | 各步骤执行结果           |
| `error_info`    | 错误信息（如有）         |
| `final_status`  | 最终状态：success/failed |

------

## 6. Tool 接入规范

### 6.1 Tool 定义结构

```yaml
name: create_simulation_task
description: |
  创建覆盖仿真任务。
  需要提供城市名称、工参配置、仿真区域等参数。
  返回任务ID，可用于后续查询任务状态。
parameters:
  type: object
  required:
    - city_name
    - polygon
  properties:
    city_name:
      type: string
      description: 目标城市名称
    polygon:
      type: array
      description: 仿真区域边界坐标点
    config:
      type: object
      description: 工参配置（可选）
returns:
  type: object
  properties:
    task_id:
      type: string
    status:
      type: string
```

### 6.2 接入方职责

1. 按规范定义 Tool 的 Schema（OpenAPI 格式 + 语义描述）
2. 通过编码方式注册 Tool
3. 提供相关领域知识文档

------

## 7. 约束与限制

### 7.1 系统限制

| 限制项               | 默认值 | 可配置 |
| -------------------- | ------ | ------ |
| 单任务最大步骤数     | 20     | ✅      |
| 嵌套深度（SubAgent） | 3 层   | ✅      |
| 单步重试次数         | 3 次   | ✅      |
| Tool 执行超时        | 60s    | ✅      |

### 7.2 用户限制

| 限制项               | 说明                     |
| -------------------- | ------------------------ |
| 不可取消执行中的步骤 | 只能等待完成或失败       |
| 不可跳过失败步骤     | 失败后需重新开始对话     |
| 不可修改 Agent 计划  | 暂不支持用户调整执行顺序 |

------

## 8. Token 管理策略

### 8.1 压缩策略

| 消息类型  | 压缩方式                 |
| --------- | ------------------------ |
| Tool 消息 | 规则裁剪（保留关键结果） |
| LLM 回复  | LLM 智能摘要压缩         |
| 用户消息  | 保留原文                 |

### 8.2 上下文窗口管理

- 超出 Token 限制时，优先压缩历史 Tool 调用结果
- 保留最近 N 轮核心对话
- 关键决策点信息始终保留

------

## 9. 验收标准

### 9.1 MVP 验收项

| 验收项        | 验收标准                              | 优先级 |
| ------------- | ------------------------------------- | ------ |
| Tool 动态加载 | 按规范注册的 Tool 可被 Agent 识别调用 | P0     |
| 多步骤编排    | 正确识别 Tool 间依赖并按序执行        | P0     |
| TODO 可视化   | 步骤状态实时更新，支持折叠            | P0     |
| 参数动态表单  | 根据 Schema 自动生成配置界面          | P0     |
| 任务持久化    | 刷新/重开浏览器后可恢复               | P0     |
| 多任务并行    | 支持同时运行多个任务                  | P0     |
| 知识检索      | RAG 检索结果辅助参数填充              | P0     |
| 失败处理      | 显示具体失败步骤 + 错误原因           | P0     |

### 9.2 验收场景示例

**场景：创建仿真任务**

1. 用户输入："帮我创建一个北京市的覆盖仿真任务"
2. Agent 识别意图，生成 TODO 列表：
   - 步骤1：获取用户基本配置偏好
   - 步骤2：确认仿真区域（polygon）
   - 步骤3：确认工参配置
   - 步骤4：创建仿真任务
   - 步骤5：返回任务ID
3. 执行过程中，步骤状态实时更新
4. 需要用户输入时，弹出动态表单
5. 成功后显示任务ID，失败则显示具体原因

------

## 10. 附录

### 10.1 术语表

| 术语       | 定义                                        |
| ---------- | ------------------------------------------- |
| Tool       | 封装后的 API 能力单元，供 Agent 调用        |
| Agent      | 基于 LLM 的智能决策单元                     |
| Checkpoint | LangGraph 状态快照，用于恢复执行            |
| Thread     | LangGraph 中的会话线程，关联一组 Checkpoint |

### 10.2 相关文档

- LangGraph 状态设计文档（见附件）
- Tool 接入开发指南（待编写）
- 前端交互设计稿（待输出）